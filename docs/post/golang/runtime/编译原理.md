---
title: "编译原理"
date: "2020-12-18 14:26:35"
tag: ["Golang","编译","Linux"]
categories: ["Golang","Linux"]
draft: true
---



## 一.编译预备知识

- 抽象语法树

  - **源代码语法结构**的一种抽象表示
  - 树状
  - 每个节点表示源代码的一个元素
  - 每一个子树都表示语法元素

- 静态单赋值

  - 中间代码的特性

  - 对代码进行优化，减少需要执行的指令

    ```go
    x := 1
    x := 2
    y := x
    // 优化后
    x_1 := 1
    x_2 := 2
    y_1 := x_2
    ```

- 指令集

  - 不同机器不同的指令集(x86_64、arm)



## 二.编译原理
> go 编译器源代码 src/cmd/compile

- 编译器的组成

  - 前端
    - 词法分析
    - 语法分析
    - 类型检查
    - 中间代码
  - 后端
    - 目标代码生成(翻译成目标机器码)
    - 目标代码优化

- 编译器的阶段
  1. 词法和语法分析(从源文件到语法树)

     - 词法分析：解析代码源文件、将字符串序列转换成Token序列（这个过程称为词法解析器lexer）

     - 语法分析：将token序列按照编程定义好的文法(Grammar)自下而上或者自上而下的规约将每一个go源文件归纳为SourceFile；语法分析会把 Token 序列转换成有意义的结构体

       ```go
       // Token 序列
       package, json, import, (, io, ), …
     // SourceFile
       SourceFile = PackageClause ";" { ImportDecl ";" } { TopLevelDecl ";" } .
     ```
       
       ```go
       "json.go": SourceFile {
           PackageName: "json",
           ImportDecl: []Import{
               "io",
           },
           TopLevelDecl: ...
       }
       ```

     

  2. 类型检查和AST转换

     1. 对语法树中的定义和使用类型进行检查
        1. 常量、类型、和函数名及类型
        2. 变量的赋值和初始化
        3. 函数和闭包的主体
        4. 哈希键值的类型
        5. 导入函数体
        6. 外部的声明
     2.  Go相关
        1. 替换 make 关键字为内建函数 runtime.makeslice、runtime.makechan
        2. 结构体对接口的实现

  3. 通用SSA生成

  4. 机器代码生成

     1. 不同类型的cpu分别使用不同包生成机器码

        >  amd64、arm、arm64、mips、mips64、ppc64、s390x、x86 和 wasm

  5. Go 语言的编译器

     [`src/cmd/compile/internal/gc/main.go`](https://github.com/golang/go/blob/master/src/cmd/compile/internal/gc/main.go)



## 相关文章

https://draveness.me/golang/docs/part1-prerequisite/ch02-compile/golang-compile-intro/

