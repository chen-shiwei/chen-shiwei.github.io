---
title: "缓存"
date: "2020-12-03"
tag: ["Redis"]
categories: ["Redis"]
draft: true
---


## 类型

- 本地缓存
  在内存中进行缓存，利用 map、gocache。
  - 优点：内存访问、没有远程交互开销
  -
- 分布式缓存
  良好的水平扩展能力（空间）、但是需求远程请求
- 多节缓存（本地缓存+分布式缓存）
  本地缓存 保存访问频率最高的热点数据
  其余放在分布式缓存

```
为了保证较高性能，都是使用内存来保存数据，由于成本和内存限制，当存储的数据超过缓存容量时，需要对缓存的数据进行剔除
```

- FIFO 淘汰最早数据
- LRU 剔除最早最少使用
- LFU 剔除最近使用频率最低的

## redis

![image](/img/redis.png)

### 支持的基本数据结构

- string
  最常用类型，通过 sds（simple dynamic string）存储，分配冗余空间减少内存的频繁分配
  但不是所有类型都用 string 例如 List 和对象 用 string 序列化存储，再反序列化取出。
  最合适的场景使用最合适的数据结构。
  使用场景：
  - 缓存功能
  - 计数器
  - 共享用户 session
- hash
  类似于 map 结构化的数据，操作某个字段
- list
  有序列表
  存储列表型的数据结构
  类似于粉丝列表，文章评论列表
  lrange 读取区间数据 分页查询
  消息队列
- set
  去重 交集 并集 差集
- sort set
  有序 去重
  排行榜 热搜榜

### 扩展功能

- bitmap
  布隆过滤器 BloomFilter
- HyperLogLog
  不精确的去重计数功能
- Geospatial
  保存地理位置，位置距离计算、半径计算
  附近的人 最优地图路径
- pub/sub
  订阅 订阅
- pipeline
  批量执行一组指令 一次性返回全部结果 减少频繁远程交互
- Lua
  脚本命令
- 事务
  串行化执行 失败不回滚

### 持久化 rdb aof

rdb
把 redis 内存中的数据以快照的形式写入磁盘，redis fork 一个子进程执行，采用二进制压缩。
适合灾备、但容易丢失一段时间的数据，保存快照服务不可用
aof 追加记录保存 redis 写和删除命令的日志
灵活的同步策略，支持秒级同步，每次修改同步和不同步 缺点就是相同规模的数据集，AOF 要大于 RDB，AOF 在运行效率上往往会慢于 RDB

### 高可用

- Redis Cluster
  使用分片机制，在内部分为 16384 个 slot 插槽，分布在所有 master 节点上，每个 master 节点负责一部分 slot。数据操作时按 key 做 CRC16 来计算在哪个 slot，由哪个 master 进行处理。数据的冗余是通过 slave 节点来保障。
- 哨兵
  哨兵+主从并不能保证数据不丢失，但是可以保证集群的高可用
- 主从
  master 机器写
  slave 机器读 第一次 psync master 全量 rdb 同步给 slave，之后 aof 增量同步
- key 失效机器
  主动删除 被动删除（key 到期） 内存淘汰
- 缓存问题
